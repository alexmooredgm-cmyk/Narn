<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>NARN</title>
  <style>
    /* ── Reset / Base ── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #000; }

    body {
      font-family: 'Courier New', Courier, monospace;
      color: #ddd;
    }

    /* ── Canvas ── */
    #canvas {
      display: block;
      position: absolute;
      top: 0; left: 0;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    /* ── HUD overlay ── */
    #hud {
      position: absolute;
      top: 12px; left: 12px;
      pointer-events: none;
      z-index: 10;
    }

    #hp-bar-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    #hp-label { font-size: 11px; color: #c97fff; letter-spacing: 1px; }
    #hp-bar-bg {
      width: 120px; height: 8px;
      background: #1a0025;
      border: 1px solid #5a008a;
      border-radius: 2px;
      overflow: hidden;
    }
    #hp-bar-fill {
      height: 100%; width: 100%;
      background: linear-gradient(90deg, #6a00ff, #c97fff);
      transition: width 0.2s ease;
    }

    #class-label {
      font-size: 10px;
      color: #7a7a9a;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    #ability-wrap {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #ability-label { font-size: 10px; color: #7a7a9a; }
    #ability-bar-bg {
      width: 80px; height: 5px;
      background: #111;
      border: 1px solid #333;
      border-radius: 2px;
      overflow: hidden;
    }
    #ability-bar-fill {
      height: 100%; width: 0%;
      background: #c97fff;
      transition: width 0.1s linear;
    }

    /* ── Pause menu ── */
    #pause-menu {
      display: none;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(5, 0, 15, 0.95);
      border: 1px solid #5a008a;
      border-radius: 8px;
      padding: 32px 48px;
      text-align: center;
      z-index: 20;
      min-width: 240px;
    }
    #pause-menu h2 {
      font-size: 22px;
      letter-spacing: 6px;
      color: #c97fff;
      margin-bottom: 24px;
      text-transform: uppercase;
    }
    .menu-btn {
      display: block;
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      background: transparent;
      border: 1px solid #5a008a;
      color: #ddd;
      font-family: 'Courier New', Courier, monospace;
      font-size: 13px;
      letter-spacing: 2px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.15s, color 0.15s;
      text-transform: uppercase;
    }
    .menu-btn:hover { background: #3a0070; color: #fff; }

    /* ── Main menu ── */
    #main-menu {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: radial-gradient(ellipse at center, #0a001a 0%, #000 100%);
      z-index: 30;
    }
    #main-menu h1 {
      font-size: clamp(40px, 10vw, 72px);
      letter-spacing: 16px;
      color: #c97fff;
      text-shadow: 0 0 40px #8b00ff, 0 0 80px #4a0080;
      margin-bottom: 8px;
    }
    #main-menu .tagline {
      font-size: 12px;
      color: #5a5a7a;
      letter-spacing: 4px;
      margin-bottom: 48px;
    }
    #main-menu .menu-btn { width: 220px; margin: 6px auto; }

    /* ── Character select ── */
    #char-select {
      display: none;
      position: absolute;
      inset: 0;
      background: rgba(5, 0, 15, 0.97);
      z-index: 31;
      overflow-y: auto;
      padding: 32px 20px;
    }
    #char-select h2 {
      text-align: center;
      color: #c97fff;
      letter-spacing: 6px;
      margin-bottom: 24px;
      text-transform: uppercase;
    }
    #char-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      max-width: 700px;
      margin: 0 auto 24px;
    }
    .char-card {
      border: 1px solid #330055;
      border-radius: 6px;
      padding: 14px 10px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }
    .char-card:hover, .char-card.selected {
      border-color: #c97fff;
      background: #1a0030;
    }
    .char-card .char-icon {
      width: 32px; height: 32px;
      margin: 0 auto 8px;
      border-radius: 4px;
    }
    .char-card .char-name { font-size: 13px; color: #ddd; letter-spacing: 2px; }
    .char-card .char-desc { font-size: 10px; color: #666; margin-top: 4px; font-style: italic; }

    /* ── Touch controls ── */
    #touch-controls {
      display: none;
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 160px;
      pointer-events: none;
      z-index: 15;
    }
    #joystick-zone {
      position: absolute;
      bottom: 20px; left: 20px;
      width: 110px; height: 110px;
      pointer-events: all;
      touch-action: none;
    }
    #joystick-base {
      width: 100%; height: 100%;
      border-radius: 50%;
      background: rgba(90, 0, 138, 0.25);
      border: 2px solid rgba(201, 127, 255, 0.3);
    }
    #joystick-thumb {
      position: absolute;
      width: 42px; height: 42px;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: rgba(201, 127, 255, 0.5);
      border: 2px solid #c97fff;
      pointer-events: none;
    }
    .touch-btn {
      position: absolute;
      border-radius: 50%;
      border: 2px solid rgba(201, 127, 255, 0.4);
      background: rgba(90, 0, 138, 0.3);
      color: #c97fff;
      font-size: 11px;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: all;
      touch-action: none;
      user-select: none;
    }
    #btn-jump   { width: 60px; height: 60px; bottom: 60px; right: 80px; }
    #btn-action { width: 50px; height: 50px; bottom: 20px; right: 20px; }

    /* Media — show touch controls on narrow/touch screens */
    @media (hover: none), (max-width: 600px) {
      #touch-controls { display: block; }
    }

    /* ── Notification flash ── */
    #notif {
      position: absolute;
      top: 60px; left: 50%;
      transform: translateX(-50%);
      background: rgba(5,0,15,0.9);
      border: 1px solid #5a008a;
      border-radius: 4px;
      padding: 6px 16px;
      font-size: 11px;
      letter-spacing: 2px;
      color: #c97fff;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 25;
    }
    #notif.show { opacity: 1; }
  </style>
</head>
<body>

<!-- ── Game canvas ── -->
<canvas id="canvas"></canvas>

<!-- ── HUD ── -->
<div id="hud">
  <div id="hp-bar-wrap">
    <span id="hp-label">HP</span>
    <div id="hp-bar-bg"><div id="hp-bar-fill"></div></div>
  </div>
  <div id="class-label">—</div>
  <div id="ability-wrap">
    <span id="ability-label">ABILITY</span>
    <div id="ability-bar-bg"><div id="ability-bar-fill"></div></div>
  </div>
</div>

<!-- ── Notification ── -->
<div id="notif"></div>

<!-- ── Pause menu ── -->
<div id="pause-menu">
  <h2>Paused</h2>
  <button class="menu-btn" id="btn-resume">Resume</button>
  <button class="menu-btn" id="btn-save">Save Game</button>
  <button class="menu-btn" id="btn-main">Main Menu</button>
</div>

<!-- ── Main menu ── -->
<div id="main-menu">
  <h1>NARN</h1>
  <p class="tagline">the forest is watching</p>
  <button class="menu-btn" id="btn-new-game">New Game</button>
  <button class="menu-btn" id="btn-continue">Continue</button>
  <button class="menu-btn" id="btn-settings" style="color:#555;border-color:#222">Settings</button>
</div>

<!-- ── Character select ── -->
<div id="char-select">
  <h2>Choose Your Form</h2>
  <div id="char-grid"></div>
  <div style="text-align:center">
    <button class="menu-btn" id="btn-start-game" style="width:180px;margin:0 auto">Enter Narn</button>
  </div>
</div>

<!-- ── Touch controls ── -->
<div id="touch-controls">
  <div id="joystick-zone">
    <div id="joystick-base"></div>
    <div id="joystick-thumb"></div>
  </div>
  <div class="touch-btn" id="btn-jump">JUMP</div>
  <div class="touch-btn" id="btn-action">USE</div>
</div>

<!-- ── Scripts — order matters ── -->
<script src="engine.js"></script>
<script src="player.js"></script>
<script src="npc.js"></script>
<script src="save.js"></script>
<script src="worldgen.js"></script>
<script>
// ============================================================
// NARN — main.js (inlined)
// Wires all modules together, handles menus & HUD
// ============================================================

(function() {
  "use strict";

  // ── References ─────────────────────────────────────────────
  const $  = id => document.getElementById(id);
  const mainMenu   = $("main-menu");
  const charSelect = $("char-select");
  const pauseMenu  = $("pause-menu");
  const notif      = $("notif");

  let engine       = null;
  let isPaused     = false;
  let selectedClass = "seeker";

  // ── Notification helper ────────────────────────────────────
  let notifTimeout;
  function showNotif(msg) {
    notif.textContent = msg;
    notif.classList.add("show");
    clearTimeout(notifTimeout);
    notifTimeout = setTimeout(() => notif.classList.remove("show"), 2200);
  }

  // ── Populate character select grid ─────────────────────────
  function buildCharGrid() {
    const grid = $("char-grid");
    grid.innerHTML = "";
    const classes = window.NARN.CHARACTER_CLASSES;

    for (const [key, def] of Object.entries(classes)) {
      const card = document.createElement("div");
      card.className = "char-card";
      if (key === selectedClass) card.classList.add("selected");

      // Tiny color swatch as "icon"
      const icon = document.createElement("div");
      icon.className  = "char-icon";
      icon.style.background = def.color;

      card.appendChild(icon);
      card.innerHTML += `<div class="char-name">${def.name}</div>
                         <div class="char-desc">${def.desc}</div>`;

      card.addEventListener("click", () => {
        selectedClass = key;
        document.querySelectorAll(".char-card").forEach(c => c.classList.remove("selected"));
        card.classList.add("selected");
      });

      grid.appendChild(card);
    }
  }

  // ── Start game ─────────────────────────────────────────────
  function startGame(savedData) {
    charSelect.style.display = "none";
    mainMenu.style.display   = "none";

    // Create engine
    engine = new window.NARN.Engine("canvas");

    // Generate world
    const seed = savedData?.worldSeed || undefined;
    const mapData = window.NARN.generateWorld(seed);

    // Override player spawn character class
    const playerSpawn = mapData.spawns.find(s => s.type === "player");
    if (playerSpawn) playerSpawn.charClass = selectedClass;

    engine.loadWorld(mapData);
    engine._flags = {};

    // Apply save data if continuing
    if (savedData) {
      window.NARN.save.apply(engine, savedData);
      showNotif("WORLD REMEMBERED");
    }

    // Hook save ticker into engine update
    const origUpdate = engine.update.bind(engine);
    engine.update = function() {
      origUpdate();
      window.NARN.save.tick(engine);
      updateHUD();
    };

    // Pause on Escape
    window.addEventListener("keydown", e => {
      if (e.code === "Escape") togglePause();
    });

    engine.start();
    updateHUD();
    showNotif("NARN AWAKENS");
  }

  // ── HUD update ─────────────────────────────────────────────
  function updateHUD() {
    if (!engine?.player) return;
    const p = engine.player;

    // HP
    const hpPct = Math.max(0, p.hp / p.maxHp) * 100;
    $("hp-bar-fill").style.width = hpPct + "%";
    $("hp-bar-fill").style.background =
      hpPct > 50 ? "linear-gradient(90deg, #6a00ff, #c97fff)" :
      hpPct > 25 ? "linear-gradient(90deg, #aa0044, #ff4488)" : "#ff1744";

    // Class
    $("class-label").textContent = p.def.name.toUpperCase();

    // Ability cooldown
    const cdPct = p.abilityCd > 0
      ? (1 - p.abilityCd / p.def.abilityCooldown) * 100
      : 100;
    $("ability-bar-fill").style.width = cdPct + "%";
  }

  // ── Pause ──────────────────────────────────────────────────
  function togglePause() {
    isPaused = !isPaused;
    if (isPaused) {
      engine.stop();
      pauseMenu.style.display = "block";
    } else {
      engine.start();
      pauseMenu.style.display = "none";
    }
  }

  // ── Touch controls ────────────────────────────────────────
  (function initTouch() {
    const zone   = $("joystick-zone");
    const thumb  = $("joystick-thumb");
    const RADIUS = 40;
    let origin = null;
    let dx = 0, dy = 0;
    let jumpPressed = false, actionPressed = false;

    zone.addEventListener("touchstart", e => {
      e.preventDefault();
      const t = e.changedTouches[0];
      const rect = zone.getBoundingClientRect();
      origin = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
    }, { passive: false });

    zone.addEventListener("touchmove", e => {
      e.preventDefault();
      if (!origin) return;
      const t = e.changedTouches[0];
      const raw_dx = t.clientX - origin.x;
      const raw_dy = t.clientY - origin.y;
      const dist = Math.sqrt(raw_dx*raw_dx + raw_dy*raw_dy);
      const clamped = Math.min(dist, RADIUS);
      const angle = Math.atan2(raw_dy, raw_dx);
      dx = Math.cos(angle) * (clamped / RADIUS);
      dy = Math.sin(angle) * (clamped / RADIUS);
      thumb.style.transform =
        `translate(calc(-50% + ${Math.cos(angle)*clamped}px), calc(-50% + ${Math.sin(angle)*clamped}px))`;
      if (engine) engine.input.setTouch(dx, dy, false, false);
    }, { passive: false });

    zone.addEventListener("touchend", e => {
      e.preventDefault();
      dx = dy = 0;
      thumb.style.transform = "translate(-50%, -50%)";
      if (engine) engine.input.setTouch(0, 0, false, false);
    }, { passive: false });

    // Jump button
    $("btn-jump").addEventListener("touchstart", e => {
      e.preventDefault();
      jumpPressed = true;
      if (engine) engine.input.setTouch(dx, dy, true, false);
    }, { passive: false });
    $("btn-jump").addEventListener("touchend", e => {
      e.preventDefault();
      jumpPressed = false;
      if (engine) engine.input.setTouch(dx, dy, false, false);
    }, { passive: false });

    // Action button
    $("btn-action").addEventListener("touchstart", e => {
      e.preventDefault();
      actionPressed = true;
      if (engine) engine.input.setTouch(dx, dy, false, true);
    }, { passive: false });
    $("btn-action").addEventListener("touchend", e => {
      e.preventDefault();
      actionPressed = false;
      if (engine) engine.input.setTouch(dx, dy, false, false);
    }, { passive: false });
  })();

  // ── Menu events ────────────────────────────────────────────
  $("btn-new-game").addEventListener("click", () => {
    mainMenu.style.display = "none";
    buildCharGrid();
    charSelect.style.display = "block";
  });

  $("btn-continue").addEventListener("click", () => {
    const data = window.NARN.save.loadFromSlot("auto") ||
                 window.NARN.save.loadFromSlot(0);
    if (!data) {
      showNotif("NO SAVE FOUND");
      mainMenu.style.display = "none";
      buildCharGrid();
      charSelect.style.display = "block";
      return;
    }
    selectedClass = data.player?.charClass || "seeker";
    startGame(data);
  });

  $("btn-start-game").addEventListener("click", () => startGame(null));

  $("btn-resume").addEventListener("click", () => togglePause());

  $("btn-save").addEventListener("click", () => {
    const ok = window.NARN.save.saveToSlot(engine, 0);
    showNotif(ok ? "SAVED." : "SAVE FAILED.");
  });

  $("btn-main").addEventListener("click", () => {
    engine?.stop();
    engine = null;
    isPaused = false;
    pauseMenu.style.display = "none";
    mainMenu.style.display  = "flex";
    showNotif("");
  });

  // ── Check for autosave on load ─────────────────────────────
  const autosave = window.NARN.save.loadFromSlot("auto");
  if (autosave) {
    // Tease the continue button
    $("btn-continue").textContent =
      `Continue (${autosave.player?.charClass || "?"})`;
  }

})();
</script>
</body>
</html>
